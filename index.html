<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>GPS Grave Grid - Fixed Precision</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; }
        .ui-overlay {
            position: fixed; top: 0; left: 0; width: 100%;
            z-index: 100; padding: 10px; background: rgba(0,0,0,0.85);
            color: white; display: flex; flex-direction: column; gap: 8px;
        }
        .input-row { display: flex; gap: 5px; align-items: center; justify-content: center; flex-wrap: wrap; }
        input { width: 90px; padding: 5px; border-radius: 4px; border: none; font-size: 12px; }
        .btn-update { background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 4px; font-weight: bold; }
        .btn-sync { background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 4px; font-weight: bold; }
        #debug { font-size: 11px; color: #ffc107; text-align: center; }
    </style>
</head>

<body>
    <div class="ui-overlay">
        <div class="input-row">
            <input type="number" id="latInput" value="52.367972" step="0.000001">
            <input type="number" id="lngInput" value="13.194501" step="0.000001">
            <button class="btn-update" onclick="applySettings()">UPDATE</button>
            <button class="btn-sync" onclick="syncToCurrentLocation()">SET AT MY FEET</button>
        </div>
        <div id="debug">Stand at the tree and hit "SET AT MY FEET"</div>
    </div>

    <a-scene 
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true;">

        <a-camera gps-camera="enableHighAccuracy: true; minDistance: 0.1;" rotation-reader></a-camera>
        <a-entity id="tree-center"></a-entity>
    </a-scene>

    <script>
        const tree = document.querySelector('#tree-center');
        const debug = document.getElementById('debug');

        // This grabs your EXACT phone location and updates the inputs
        function syncToCurrentLocation() {
            navigator.geolocation.getCurrentPosition((pos) => {
                document.getElementById('latInput').value = pos.coords.latitude.toFixed(6);
                document.getElementById('lngInput').value = pos.coords.longitude.toFixed(6);
                applySettings();
                debug.innerText = "Grid synced to your current spot!";
            }, (err) => {
                debug.innerText = "Error getting location. Check GPS permissions.";
            }, { enableHighAccuracy: true });
        }

        function applySettings() {
            const lat = document.getElementById('latInput').value;
            const lng = document.getElementById('lngInput').value;

            tree.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lng};`);

            while (tree.firstChild) { tree.removeChild(tree.firstChild); }

            // Increased distances slightly to ensure they aren't "under" you
            generateRing(tree, 1, 16, 2.5, "#00ff00"); 
            generateRing(tree, 17, 40, 5.0, "#00ccff");
        }

        function generateRing(parent, startNum, endNum, dist, color) {
            const total = (endNum - startNum) + 1;
            const perSide = total / 4;
            const step = (dist * 2) / perSide;

            for (let i = 0; i < total; i++) {
                const container = document.createElement('a-entity');
                let x = 0, z = 0;
                const side = Math.floor(i / perSide);
                const progress = (i % perSide) * step - dist;

                if (side === 0) { x = progress; z = -dist; } 
                else if (side === 1) { x = dist; z = progress; } 
                else if (side === 2) { x = -progress; z = dist; } 
                else if (side === 3) { x = -dist; z = -progress; }

                // Lifted slightly higher (0.5) to stop them disappearing into the ground
                container.setAttribute('position', `${x} 0.5 ${z}`);

                const ring = document.createElement('a-ring');
                ring.setAttribute('radius-inner', '0.3');
                ring.setAttribute('radius-outer', '0.4');
                ring.setAttribute('color', color);
                ring.setAttribute('rotation', '-90 0 0');
                container.appendChild(ring);

                const label = document.createElement('a-text');
                label.setAttribute('value', startNum + i);
                label.setAttribute('align', 'center');
                label.setAttribute('scale', '3 3 3'); // Made bigger
                label.setAttribute('position', '0 0.8 0');
                label.setAttribute('look-at', '[gps-camera]'); 
                container.appendChild(label);

                parent.appendChild(container);
            }
        }

        window.onload = () => { applySettings(); };
    </script>
</body>
</html>