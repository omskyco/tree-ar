<!DOCTYPE html>
<html>
<head>
    <title>Grave Grid - iPhone Fixed</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <style>
        /* Force the body and html to be transparent so the camera shows through */
        body, html { margin: 0; overflow: hidden; width: 100%; height: 100%; background-color: transparent; }
        
        #ui { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
            z-index: 9999; display: flex; flex-direction: column; gap: 10px; 
            align-items: center; width: 90%; pointer-events: none; 
        }
        button { 
            pointer-events: auto; padding: 15px 30px; font-size: 18px; 
            border-radius: 30px; border: none; color: white; font-weight: bold; width: 100%; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        #startBtn { background: #007bff; }
        #lockBtn { background: #28a745; display: none; }
        #debug { 
            position: fixed; top: 10px; right: 10px; color: yellow; 
            background: rgba(0,0,0,0.6); padding: 8px; font-family: monospace; z-index: 10000; 
            border-radius: 5px; font-size: 12px;
        }
    </style>
</head>

<body>
    <div id="debug">Status: Waiting for Start...</div>
    
    <div id="ui">
        <button id="startBtn">1. ACCESS CAMERA & COMPASS</button>
        <button id="lockBtn">2. LOCK GRID TO NORTH</button>
    </div>

    <a-scene 
        embedded 
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        renderer="antialias: true; alpha: true; precision: medium;">
        
        <a-entity id="grid-anchor"></a-entity>

        <a-camera id="cam" look-controls="enabled: false" wasd-controls-enabled="false"></a-camera>
    </a-scene>

    <script>
        let compassHeading = 0;
        const gridAnchor = document.getElementById('grid-anchor');
        const cam = document.getElementById('cam');
        const startBtn = document.getElementById('startBtn');
        const lockBtn = document.getElementById('lockBtn');
        const debug = document.getElementById('debug');

        startBtn.addEventListener('click', () => {
            // iOS Permission Check
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(response => {
                    if (response == 'granted') {
                        initCompass();
                        startBtn.style.display = 'none';
                        lockBtn.style.display = 'block';
                        debug.innerText = "Compass: Active";
                    } else {
                        debug.innerText = "Permission Denied";
                    }
                }).catch(err => {
                    debug.innerText = "Error: Use HTTPS";
                });
            } else {
                initCompass();
                startBtn.style.display = 'none';
                lockBtn.style.display = 'block';
            }
        });

        function initCompass() {
            window.addEventListener('deviceorientationabsolute', (e) => {
                compassHeading = e.webkitCompassHeading || (360 - e.alpha);
                debug.innerText = `North: ${Math.round(compassHeading)}Â°`;
            }, true);
        }

        lockBtn.addEventListener('click', () => {
            // Get camera position
            const camPos = cam.object3D.position;
            
            // Set anchor at feet and rotate to North
            gridAnchor.setAttribute('position', `${camPos.x} -1.6 ${camPos.z}`);
            gridAnchor.setAttribute('rotation', `0 ${-compassHeading} 0`);
            
            // Use your perfected Slot Math
            buildGrid(1, 16, "#00ff00");
            buildGrid(17, 40, "#00ccff");
            
            lockBtn.style.display = 'none';
            debug.innerText = "GRID LOCKED";
        });

        function buildGrid(start, end, color) {
            const spacing = 0.85;
            for (let num = start; num <= end; num++) {
                let gridX = 0, gridZ = 0;
                
                if (start === 1) {
                    const innerMap = {
                        16:[-1,-2], 1:[0,-2], 2:[1,-2], 3:[2,-2],
                        4:[2,-1], 5:[2,0], 6:[2,1], 7:[2,2],
                        8:[1,2], 9:[0,2], 10:[-1,2], 11:[-2,2],
                        12:[-2,1], 13:[-2,0], 14:[-2,-1], 15:[-2,-2]
                    };
                    [gridX, gridZ] = innerMap[num] || [0,0];
                } else {
                    if (num >= 38 && num <= 40) { gridX = num - 41; gridZ = -3; }
                    else if (num >= 17 && num <= 20) { gridX = num - 17; gridZ = -3; }
                    else if (num >= 21 && num <= 25) { gridX = 3; gridZ = num - 23; }
                    else if (num >= 26 && num <= 32) { gridX = 29 - num; gridZ = 3; }
                    else if (num >= 33 && num <= 37) { gridX = -3; gridZ = 35 - num; }
                }

                const entity = document.createElement('a-entity');
                entity.setAttribute('position', `${gridX * spacing} 0 ${gridZ * spacing}`);
                
                const ring = document.createElement('a-ring');
                ring.setAttribute('radius-inner', '0.25');
                ring.setAttribute('radius-outer', '0.32');
                ring.setAttribute('color', color);
                ring.setAttribute('rotation', '-90 0 0');
                entity.appendChild(ring);

                const text = document.createElement('a-text');
                text.setAttribute('value', num);
                text.setAttribute('align', 'center');
                text.setAttribute('width', '4');
                text.setAttribute('position', '0 0.05 0');
                text.setAttribute('rotation', '-90 0 0');
                entity.appendChild(text);

                gridAnchor.appendChild(entity);
            }
        }
    </script>
</body>
</html>