<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GPS Grave Grid - AR.js Example</title>

    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.5/aframe/build/aframe-ar.js"></script>

    <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: black; }
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; font-family: sans-serif; text-align: center;
        }
        .ui-container {
            position: fixed; top: 0; left: 0; width: 100%;
            z-index: 1000; padding: 10px; background: rgba(0,0,0,0.8);
            color: white; font-family: sans-serif; display: flex; gap: 8px; justify-content: center; align-items: center;
        }
        input { width: 95px; padding: 10px; border-radius: 4px; border: none; font-size: 14px; }
        button { padding: 10px 15px; background: #007bff; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
        #startBtn { padding: 20px 40px; font-size: 18px; background: #28a745; margin-top: 10px; cursor: pointer; }
    </style>
</head>

<body>
    <div id="overlay">
        <h1>GPS Grid Sync</h1>
        <p>Permissions required for GPS & Compass</p>
        <button id="startBtn">START AR</button>
    </div>

    <div class="ui-container">
        <input type="number" id="latInput" value="52.367972" step="0.000001">
        <input type="number" id="lngInput" value="13.194501" step="0.000001">
        <button id="updateBtn">UPDATE</button>
    </div>

    <a-scene vr-mode-ui="enabled: false" embedded arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;">
        <!-- Optional: simulate GPS for testing -->
        <a-camera gps-camera="simulateLatitude:52.367972; simulateLongitude:13.194501; minDistance:1;" rotation-reader></a-camera>

        <a-entity id="grid-parent"></a-entity>
    </a-scene>

    <script>
        const gridParent = document.getElementById('grid-parent');
        const startBtn = document.getElementById('startBtn');
        const updateBtn = document.getElementById('updateBtn');
        const overlay = document.getElementById('overlay');

        const scene = document.querySelector('a-scene');
        const camera = document.querySelector('[gps-camera]');
        let gpsReady = false;

       scene.addEventListener('loaded', () => {
    console.log('Scene loaded ✅');

    camera.addEventListener('gps-camera-update-position', () => {
        console.log('GPS fix acquired ✅');
        gpsReady = true;
        rebuildGrid();
    }, { once: true });
});

startBtn.addEventListener('click', () => {
    overlay.style.display = 'none';
    console.log('Start button clicked');

    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission()
            .then(() => console.log('Device orientation permission granted'))
            .catch(e => console.error('Device orientation permission denied', e));
    }

    // Immediately rebuild grid for testing with simulated GPS
    gpsReady = true;
    rebuildGrid();
});


updateBtn.addEventListener('click', () => {
    console.log('Update button clicked');
    if (!gpsReady) return console.warn("GPS not ready yet!");
    rebuildGrid();
});

function rebuildGrid() {
    console.log("Rebuilding grid...");
    alert("Rebuilding grid..."); // visual confirmation

    const lat = parseFloat(document.getElementById('latInput').value);
    const lng = parseFloat(document.getElementById('lngInput').value);
    console.log("Grid rebuild called at:", lat, lng);

    while (gridParent.firstChild) gridParent.removeChild(gridParent.firstChild);

    const newAnchor = document.createElement('a-entity');
    newAnchor.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lng};`);
    
    generateRing(newAnchor, 1, 16, 2.0, "#00ff00");
    generateRing(newAnchor, 17, 40, 4.0, "#00ccff");

    gridParent.appendChild(newAnchor);
    console.log('Grid added to scene ✅');
}



        function generateRing(parent, startNum, endNum, dist, color) {
            const total = (endNum - startNum) + 1;
            const perSide = total / 4;
            const step = (dist * 2) / perSide;

            for (let i = 0; i < total; i++) {
                const container = document.createElement('a-entity');
                let x = 0, z = 0;
                const side = Math.floor(i / perSide);
                const progress = (i % perSide) * step - dist;

                if (side === 0) { x = progress; z = -dist; } 
                else if (side === 1) { x = dist; z = progress; } 
                else if (side === 2) { x = -progress; z = dist; } 
                else if (side === 3) { x = -dist; z = -progress; }

                container.setAttribute('position', `${x} 0.1 ${z}`);

                const ring = document.createElement('a-ring');
                ring.setAttribute('radius-inner', '0.28');
                ring.setAttribute('radius-outer', '0.35');
                ring.setAttribute('color', color);
                ring.setAttribute('rotation', '-90 0 0');
                ring.setAttribute('material', 'shader: flat;');
                container.appendChild(ring);

                const label = document.createElement('a-text');
                label.setAttribute('value', startNum + i);
                label.setAttribute('align', 'center');
                label.setAttribute('width', '1'); // small width to fit the ring
                label.setAttribute('color', '#FFFFFF');
                label.setAttribute('rotation', '-90 0 0');
                label.setAttribute('position', '0 0.02 0'); 
                container.appendChild(label);

                parent.appendChild(container);
            }
        }
    </script>
</body>
</html>
