<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>test2</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; }
        
  
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 999; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between; align-items: center;
        }

        .button-container { padding: 20px; pointer-events: auto; }

        .btn {
            background: #ef3160; color: white; border: none; padding: 15px 30px;
            font-size: 16px; border-radius: 8px; font-weight: bold; cursor: pointer;
        }

        #status-bar {
            background: rgba(0,0,0,0.8); color: white; padding: 10px 20px;
            margin-top: 20px; border-radius: 20px; font-size: 14px;
        }
    </style>
</head>

<body>
    <div id="overlay">
        <div id="status-bar">1. TAP START -> 2. FACE NORTH -> 3. LOCK</div>
        
        <div class="button-container">
            <button id="mainBtn" class="btn">START AR SESSION</button>
        </div>
    </div>

    <a-scene 
        embedded 
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
        renderer="antialias: true; alpha: true;">
        
        <a-entity id="master-grid"></a-entity>
        
        <a-camera id="camera" look-controls-enabled="false"></a-camera>
    </a-scene>

    <script>
        const mainBtn = document.getElementById('mainBtn');
        const statusBar = document.getElementById('status-bar');
        const masterGrid = document.getElementById('master-grid');
        const camera = document.querySelector('#camera');

        let state = "INIT"; 
        let heading = 0;

        // --- COMPASS LOGIC ---
        function handleOrientation(e) {
            heading = e.webkitCompassHeading || (360 - e.alpha);
            if (state === "WAIT_LOCK") {
                statusBar.innerText = `HEADING: ${Math.round(heading)}Â° NORTH`;
            }
        }

        // --- BUTTON LOGIC ---
        mainBtn.addEventListener('click', () => {
            if (state === "INIT") {
                // Request Permission (iOS)
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission().then(res => {
                        if (res === 'granted') startCompass();
                    });
                } else {
                    startCompass();
                }
            } 
            else if (state === "WAIT_LOCK") {
                lockGrid();
            }
        });

        function startCompass() {
            window.addEventListener('deviceorientationabsolute', handleOrientation, true);
            state = "WAIT_LOCK";
            mainBtn.innerText = "LOCK GRID TO NORTH";
            mainBtn.style.background = "#28a745";
        }

        function lockGrid() {
            const pos = camera.object3D.position;
            
            
            masterGrid.setAttribute('position', `${pos.x} -1.6 ${pos.z}`);
            
          
            masterGrid.setAttribute('rotation', `0 ${-heading} 0`);
            
        
            drawGraveGrid();

            state = "LOCKED";
            mainBtn.style.display = "none";
            statusBar.innerText = "GRID LOCKED";
        }

  
        function drawGraveGrid() {
            const step = 0.85; 
            
            // Layout map for 1-16
            const innerCircles = {
                16:[-1,-2], 1:[0,-2], 2:[1,-2], 3:[2,-2],
                4:[2,-1], 5:[2,0], 6:[2,1], 7:[2,2],
                8:[1,2], 9:[0,2], 10:[-1,2], 11:[-2,2],
                12:[-2,1], 13:[-2,0], 14:[-2,-1], 15:[-2,-2]
            };

            for (let i = 1; i <= 40; i++) {
                let x = 0, z = 0;
                let col = "#00ff00";

                if (i <= 16) {
                    [x, z] = innerCircles[i];
                } else {
                    col = "#00ccff";
                    // Simple ring math for outer (17-40)
                    if (i >= 38) { x = i - 41; z = -3; }
                    else if (i >= 17 && i <= 20) { x = i - 17; z = -3; }
                    else if (i >= 21 && i <= 25) { x = 3; z = i - 23; }
                    else if (i >= 26 && i <= 32) { x = 29 - i; z = 3; }
                    else if (i >= 33 && i <= 37) { x = -3; z = 35 - i; }
                }

                addMarker(i, x * step, z * step, col);
            }
        }

        function addMarker(n, x, z, color) {
            const el = document.createElement('a-entity');
            el.setAttribute('position', `${x} 0 ${z}`);

            const ring = document.createElement('a-ring');
            ring.setAttribute('radius-inner', '0.22');
            ring.setAttribute('radius-outer', '0.3');
            ring.setAttribute('color', color);
            ring.setAttribute('rotation', '-90 0 0');

            const txt = document.createElement('a-text');
            txt.setAttribute('value', n);
            txt.setAttribute('align', 'center');
            txt.setAttribute('width', '3.5');
            txt.setAttribute('position', '0 0.05 0');
            txt.setAttribute('rotation', '-90 0 0');

            el.appendChild(ring);
            el.appendChild(txt);
            masterGrid.appendChild(el);
        }
    </script>
</body>
</html>