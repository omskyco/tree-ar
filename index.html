<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>GPS Grave Grid - Fixed UI</title>
    
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; }
        
        /* FORCE UI TO FRONT */
        #ui-layer {
            position: absolute; 
            top: 0; left: 0; width: 100%; height: auto;
            z-index: 9999; /* Critical: Higher than A-Frame Canvas */
            pointer-events: none; /* Lets you see through empty space */
            padding: 10px;
            box-sizing: border-box;
        }

        /* ENABLE CLICKS ON INPUTS AND BUTTONS */
        .controls {
            pointer-events: auto; /* Re-enable clicks for this box */
            background: rgba(0, 0, 0, 0.85);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .row { display: flex; gap: 8px; justify-content: space-between; }
        
        input { 
            width: 48%; padding: 8px; 
            background: #fff; border: none; border-radius: 4px;
            font-size: 16px; /* Prevents zoom on iPhone */
        }
        
        button {
            width: 100%; padding: 12px;
            border: none; border-radius: 4px;
            font-weight: bold; font-size: 14px;
            cursor: pointer;
            text-transform: uppercase;
        }

        .btn-update { background: #28a745; color: white; } /* Green */
        .btn-here { background: #007bff; color: white; }   /* Blue */
        
        button:active { opacity: 0.8; transform: scale(0.98); }

        #status-log {
            margin-top: 10px;
            color: #ffc107; /* Yellow */
            font-size: 12px;
            font-family: monospace;
            text-align: center;
            border-top: 1px solid #555;
            padding-top: 5px;
        }
    </style>
</head>

<body>

    <div id="ui-layer">
        <div class="controls">
            <div class="row">
                <input type="number" id="lat" value="52.367972" step="0.000001">
                <input type="number" id="lng" value="13.194501" step="0.000001">
            </div>
            <div class="row">
                <button class="btn-update" id="btn-set-coords">Set Coordinates</button>
            </div>
            <div class="row">
                <button class="btn-here" id="btn-use-gps">Set to My Feet</button>
            </div>
            <div id="status-log">Ready. Waiting for user...</div>
        </div>
    </div>

    <a-scene 
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true;">

        <a-camera gps-camera="minDistance: 0.1;" rotation-reader></a-camera>
        
        </a-scene>

    <script>
        const scene = document.querySelector('a-scene');
        const statusLog = document.getElementById('status-log');
        const latInput = document.getElementById('lat');
        const lngInput = document.getElementById('lng');

        // --- BUTTON 1: USE INPUT FIELDS ---
        document.getElementById('btn-set-coords').addEventListener('click', () => {
            statusLog.innerText = "Button Pressed: Updating...";
            const lat = parseFloat(latInput.value);
            const lng = parseFloat(lngInput.value);
            spawnGrid(lat, lng);
        });

        // --- BUTTON 2: USE MY CURRENT GPS ---
        document.getElementById('btn-use-gps').addEventListener('click', () => {
            statusLog.innerText = "Locating you...";
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Update inputs visually
                    latInput.value = lat.toFixed(6);
                    lngInput.value = lng.toFixed(6);
                    
                    spawnGrid(lat, lng);
                    statusLog.innerText = "Success: Grid spawned at your feet.";
                }, (err) => {
                    statusLog.innerText = "Error: GPS blocked or failed.";
                    console.error(err);
                }, { enableHighAccuracy: true });
            } else {
                statusLog.innerText = "GPS not supported on this browser.";
            }
        });

        // --- MAIN LOGIC: DELETE OLD GRID, MAKE NEW GRID ---
        function spawnGrid(lat, lng) {
            // 1. Remove existing tree if any
            const oldTree = document.getElementById('dynamic-tree');
            if (oldTree) {
                oldTree.parentNode.removeChild(oldTree);
            }

            // 2. Create new Tree Entity
            const newTree = document.createElement('a-entity');
            newTree.setAttribute('id', 'dynamic-tree');
            newTree.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lng};`);
            
            // 3. Add to scene
            scene.appendChild(newTree);

            // 4. Generate Rings (Inner and Outer)
            // Slightly adjusted height (0.5) to ensure visibility over grass/ground
            createRing(newTree, 1, 16, 2.0, "#99ff99"); 
            createRing(newTree, 17, 40, 4.0, "#99ccff");

            statusLog.innerText = `Grid Active at: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        }

        // --- HELPER: GENERATE CIRCLES ---
        function createRing(parent, startNum, endNum, dist, color) {
            const total = (endNum - startNum) + 1;
            const perSide = total / 4;
            const step = (dist * 2) / perSide;

            for (let i = 0; i < total; i++) {
                const container = document.createElement('a-entity');
                let x = 0, z = 0;
                const side = Math.floor(i / perSide);
                const progress = (i % perSide) * step - dist;

                // North (-Z), East (+X), South (+Z), West (-X)
                if (side === 0) { x = progress; z = -dist; }
                else if (side === 1) { x = dist; z = progress; }
                else if (side === 2) { x = -progress; z = dist; }
                else if (side === 3) { x = -dist; z = -progress; }

                // Position relative to tree (in meters)
                container.setAttribute('position', `${x} 0.5 ${z}`);

                // The Ring
                const ring = document.createElement('a-ring');
                ring.setAttribute('radius-inner', '0.3');
                ring.setAttribute('radius-outer', '0.4');
                ring.setAttribute('color', color);
                ring.setAttribute('rotation', '-90 0 0'); // Flat on ground
                ring.setAttribute('material', 'shader: flat; opacity: 1'); // Bright
                container.appendChild(ring);

                // The Text
                const text = document.createElement('a-text');
                text.setAttribute('value', startNum + i);
                text.setAttribute('align', 'center');
                text.setAttribute('scale', '3 3 3'); 
                text.setAttribute('position', '0 0.8 0'); // Float above ring
                text.setAttribute('look-at', '[gps-camera]'); 
                container.appendChild(text);

                parent.appendChild(container);
            }
        }
    </script>
</body>
</html>