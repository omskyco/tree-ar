<!DOCTYPE html>
<html>
<head>
    <title>Grave Mapper - Spatial Capture</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; }
        
        .ui-panel {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: rgba(0,0,0,0.85); color: white;
            padding: 20px; border-radius: 15px; width: 85%; max-width: 400px;
            text-align: center; border: 1px solid #444;
        }

        .crosshair {
            position: fixed; top: 50%; left: 50%; width: 30px; height: 30px;
            border: 2px solid #00ff00; border-radius: 50%;
            transform: translate(-50%, -50%); z-index: 1000; pointer-events: none;
        }

        button {
            background: #28a745; color: white; border: none; padding: 18px;
            font-weight: bold; border-radius: 10px; width: 100%; font-size: 18px;
            cursor: pointer; margin-top: 10px;
        }

        #output {
            font-family: monospace; font-size: 14px; color: #00ff00;
            margin-top: 10px; white-space: pre-wrap; text-align: left;
        }
    </style>
</head>

<body>
    <div class="crosshair"></div>

    <div class="ui-panel">
        <div id="status">GPS: Initializing...</div>
        <div id="output">Point at the ground & click</div>
        <button onclick="capturePoint()">PLACE PIN & GET GPS</button>
        <button onclick="location.reload()" style="background:#444; padding: 10px; font-size: 12px; margin-top: 5px;">REBOOT SENSORS</button>
    </div>

    <a-scene embedded vr-mode-ui="enabled: false" arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;">
        <a-camera id="camera" rotation-reader></a-camera>
        <a-entity id="marker-holder"></a-entity>
    </a-scene>

    <script>
        let currentLat = 0;
        let currentLon = 0;

        // Watch GPS for the base coordinate
        navigator.geolocation.watchPosition((pos) => {
            currentLat = pos.coords.latitude;
            currentLon = pos.coords.longitude;
            document.getElementById('status').innerHTML = `GPS Accuracy: ${pos.coords.accuracy.toFixed(1)}m`;
        }, (err) => {
            document.getElementById('status').innerText = "GPS Error: " + err.message;
        }, { enableHighAccuracy: true });

        function capturePoint() {
            const cam = document.querySelector('#camera');
            const holder = document.querySelector('#marker-holder');
            
            // Get rotation to see where you are looking
            const rot = cam.getAttribute('rotation');
            const angle = rot.y * (Math.PI / 180);

            // Drop pin 3 meters in front
            const distance = 3;
            const x = -Math.sin(angle) * distance;
            const z = -Math.cos(angle) * distance;

            // Create Pin in Local AR Space
            const pin = document.createElement('a-entity');
            pin.setAttribute('position', `${x} 0 ${z}`);
            pin.innerHTML = `
                <a-cylinder color="#ff0000" height="6" radius="0.05" position="0 3 0"></a-cylinder>
                <a-ring color="#ff0000" rotation="-90 0 0" radius-inner="0.2" radius-outer="0.3"></a-ring>
            `;
            holder.appendChild(pin);

            // Calculate target GPS coords
            const latOffset = (z / 111320);
            const lonOffset = (x / (111320 * Math.cos(currentLat * Math.PI / 180)));
            
            const finalLat = currentLat + latOffset;
            const finalLon = currentLon + lonOffset;

            document.getElementById('output').innerHTML = 
                `PIN PLACED AT:\nLat: ${finalLat.toFixed(7)}\nLon: ${finalLon.toFixed(7)}`;
        }
    </script>
</body>
</html>